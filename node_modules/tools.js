var fs = require('fs');
var exec = require('child_process').exec;

var stream = function(directory, wss, callback) {
	fs.readdir(directory, function(err, files) {
		var scripts = [];
		files.forEach(function(file) {
			var ext = file.split('.').pop().trim();

			if(ext == 'jar')
				scripts.push(baseName(file));
		});

		callback(scripts);

		scripts.forEach(function(script) {
			var spawn = exec('tail -f ' + directory + script + '.out');

			//nohup java -jar cafex-backend-1.1.3-SNAPSHOT.jar > cafex-backend-1.1.3-SNAPSHOT.out&

		    spawn.stdout.on('data', function(data) {
		        wss.broadcast(data + '<br>');
		    });
		    spawn.stderr.on('data', function(data) {
		       wss.broadcast(data);
		    });
		    spawn.on('close', function(code) {
		    });
		});
	});
};

var baseName = function(str) {
   var base = new String(str).substring(str.lastIndexOf('/') + 1); 
    if(base.lastIndexOf(".") != -1)       
        base = base.substring(0, base.lastIndexOf("."));
   return base;
}

module.exports = {
	stream : stream
}